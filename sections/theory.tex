
\section{Kaleidoscopic event imaging theory} \label{sec:theory}

Without loss of generality, we consider a square pyramid scintillator throughout 
this paper. 
Each face of the scintillator, except for the base of the pyramid, is a specular surface.
The scintillator has an index of refraction $n>1$ and height $h$.

\subsection{Imaging configuration and model}

The world coordinate system's origin is set at the pyramid's apex with the 
$z$-axis directed perpendicular toward the pyramid's base surface.
The camera coordinate system's origin is at the center of the lens with its 
$z$-axis directed toward the scintillator in the opposite direction of the world's $z$-axis.
The $x$ and $y$ axes among the two coordinate systems are in the same directions, 
so transforming a point between the world and camera coordinate systems is 
carried out by adding or subtracting the $z$-coordinate with the distance between 
the lens and the scintillator's apex.
We denote a $z$-coordinate in the world coordinate system as $z_w$ and camera 
coordinate system as $z_c$.
We use a thin lens to model the camera.
Three important planes to note are the focal plane, the thin lens plane, and the 
sensor plane.
The focal plane is set at the apparent depth of the pyramid's apex at $z_w=h-h/n$.
A thin lens with diameter $A$ is placed at a distance $S_1$ from the focal plane. 
The sensor is placed at a distance $S_2$ from the lens.
The lens' focal length is set to $f=(S_1^{-1}+S_2^{-1})^{-1}$.
These parameters are illustrated in \cref{fig:optical_config}.

Throughout this paper, the scintillator is oriented so that its base surface's 
edges are parallel with the sensor's respective edges. 
In this manner, the normal vector for each specular surface of the scintillator is 
aligned along the $x$ or $y$ axes.
We denote the scintillator's four specular surfaces as +$x$, +$y$, -$x$, or -$y$ mirrors.

\ifthenelse{\boolean{figs_in_text}}{

\begin{figure}
\centering
\includegraphics[width=\linewidth]{optical_config_horiz.png}
\caption{\textbf{Imaging parameters and coordinate systems.} The figure only shows 
light emitted directly to the camera.} 
\label{fig:optical_config}
\end{figure}

}{}

A scintillation event is approximated as a point source of light.
Since the optical setup is constrained to short imaging distances, 
the images of an event and its mirror reflections exhibit defocus blur and 
have nonzero diameters.
An image's diameter on the sensor varies according to the event's distance from 
the focal plane, following the circle of confusion model.
Note that the camera sees an event at its apparent depth rather than its real 
depth due to the scintillator's index of refraction.
An event's real and apparent locations are separated by $d-d/n$ along the 
$z$-dimension, where $d$ is the event's real depth in the scintillator from the
base surface.
We denote an apparent location using the superscript ``$(a)$" and a real location 
by the lack of a superscript.
For an event at an apparent location $(x_0,y_0,z_{c0}^{(a)})$, 
the circle of confusion model yields
\begin{equation} \label{eqn:circ_of_conf}
c=A\frac{S_2}{S_1}\frac{|S_1-z_{c0}^{(a)}|}{z_{c0}^{(a)}}
\end{equation}
where $c$ is the image diameter at the sensor.

Light is emitted in all directions from the event.
Photons may arrive at the camera directly from the event or indirectly after 
reflecting off mirrors.
Direct photons form a complete image on the sensor, while indirect photons may 
form an image that is partially truncated or completely missing as described below.
Below, we describe the spatial relationship between an event and its mirror 
reflections, as well as their image on the sensor using a thin lens model.

\subsection{Mirror reflections and apertures}

Consider the real location of an event at $\bm{p_0}$.
Mirror $k$ with normal vector $\bm{n_k}$ produces a mirror reflection with a real 
location at 
$\bm{p_k}=\bm{T_k}\bm{p_0}$
where
\begin{equation} \label{eqn:ref_trans}
\bm{T_k}=\bm{I}_{3\times3} - 2\bm{n_k}\bm{n_k}^T
\end{equation}
is the mirror's transformation.
The mirror reflection of an event is also a point source of light.
The captured image of the mirror reflection is obtained from the photons that 
reflect off the mirror and into the camera, exhibiting the same defocus blur as if 
an event were located at $\bm{p_k}$.
However, due to the finite mirror size, the image on the sensor may be truncated 
along lines corresponding to the mirror's edges.
This occurs when $\bm{p_k}$ is behind another mirror from the camera's perspective.
The photons that are truncated from the image are those that reflect off the 
mirror adjacent to mirror $k$ near the shared edge.
Also, light in higher-order reflections over multiple mirrors may be stopped 
in previous reflections and also cause image truncations.
We term a mirror reflection's ``order" as the number of reflections its light 
underwent before forming.
Essentially, mirror $k$ behaves like an aperture to a light source at $\bm{p_k}$. 


Light from $\bm{p_k}$ that does not pass through 
mirror $k$ does not reach the camera and is truncated from the image.
\cref{fig:trunc_theory}a and c show a 2D view of the propagation of light over a first-order reflection without truncations.
\cref{fig:trunc_theory}b and d show how truncations form.
A 3D visualization of light truncation is shown in Supplementary \cref*{fig:trunc_teaser}.


\ifthenelse{\boolean{figs_in_text}}{

\begin{figure*}
\centering
\includegraphics[width=\linewidth]{truncation_theory.png}
\caption{\textbf{Mirror apertures and image truncations.} 
An event emits light onto a mirror that reflects into the camera. 
Some light might not reach the sensor due to finite mirrors and defocus blur.
Example cases include the following:
The mirror reflection is located within the focal plane (a,b,e) or beyond the focal plane (c,d).
All light that forms the mirror reflection reaches the sensor (a,c).
Some light that would form the mirror reflection is stopped at the mirror's edge 
and truncated on the sensor (b,d).
Some light that would form a second-order mirror reflection is stopped at both 
mirrors' edges and truncated on the sensor (e). 
The mirror for the second reflection in (e) is illustrated along the light's path.
Illustrations are drawn with scintillator index of refraction $n=1$.} 
\label{fig:trunc_theory}
\end{figure*}

}{}


In higher-order reflections, light reflecting off mirror $k$ can 
reflect off another mirror $l$ and generate mirror reflection 
at $\bm{p_l}=\bm{T_l} \bm{p_k}$.
The light incident on mirror $l$ from $\bm{p_k}$ passes through the aperture 
of mirror $k$.
If this light spans a partial area $A_l$ of mirror $l$, then mirror $l$'s aperture is $A_l$.
Otherwise, mirror $l$'s aperture is simply the mirror.
Mirror $l$'s aperture affects the light emitted from $\bm{p_l}$ toward another 
mirror for a higher-order reflection and toward the camera for imaging.
Higher-order reflections and imaging continue in the same manner.
A 2D view of truncations from multiple reflections is shown in \cref{fig:trunc_theory}e.


\subsection{Image truncation derivation} \label{sec:image_truncations}

Consider an event's mirror reflection located at $\bm{p_k}$ generated from mirror $k$.
Each edge of the mirror may impose a truncation line on the camera sensor.
A truncation line on the sensor, $l_\text{sensor}$, is determined as follows.
Denote a plane, $P_1$, that contains $\bm{p_k}$ and the 
mirror's edge.
Denote the line that intersects $P_1$ and the scintillator's base surface as $l_1$.
Compute the plane, $P_{\text{trunc}}$, that contains $l_1$ and $\bm{p_k}^{(a)}$.
Denote the side of $P_{\text{trunc}}$ that faces away from the mirror using the 
normal vector $\bm{n_{\text{trunc}}}$.
Compute the intersection between $P_{\text{trunc}}$ and the focal plane to be the
truncation line at the focal plane, $l_\text{focal}$.
Project $\bm{n_{\text{trunc}}}$ onto the focal plane, denoted as 
$\bm{n_{\text{focal}}}$.
Scale $l_\text{focal}$ by the magnification, $m=-\frac{S_2}{S_1}$, to obtain $l_\text{sensor}$.
Scale $\bm{n_{\text{focal}}}$ by $m$ to obtain $\bm{n_{\text{sensor}}}$.

The truncation side of $l_\text{sensor}$ where photons do not arrive depends on 
which side of the focal plane that $\bm{p_k}^{(a)}$ is located.
If $\bm{p_k}^{(a)}$ is beyond the focal plane away from the lens at a distance 
greater than $S_1$ from the lens, 
then the side of $l_\text{sensor}$ pointed to by $\bm{n_{\text{sensor}}}$ is 
truncated and contains no photon arrivals (\cref{fig:trunc_theory}b).
If $\bm{p_k}^{(a)}$ is between the focal plane and lens at a distance less than 
$S_1$ from the lens, 
then the side of $l_\text{sensor}$ opposite of $\bm{n_{\text{sensor}}}$ 
is truncated and contains no photon arrivals (\cref{fig:trunc_theory}d).

The area on the sensor where photons cannot arrive is the union of the
truncation sides of each truncation line.
We denote this area as the ``truncation zone" and its complement as the 
``acceptance zone" (\cref{fig:trunc_theory}b).
The event itself has no truncation zone on the sensor because its image is formed 
by light emitted directly to the camera without reflections.


\subsection{Image truncation theory validation}
We validate the theory on image truncations by observing that theoretically 
derived truncation lines align with photon arrivals in a simulated image.
We simulate the image of an event in a kaleidoscopic scintillator in the shape of 
a square pyramid using a thin lens and ray tracing. 
The kaleidoscope is 3.02 mm in height and has a 20 mm base length.
We set its index of refraction to 1 and place its apex at $z_w=0$ mm.
A thin lens with 30 mm focal length and 20 mm diameter is placed at $z_w=50$ mm.
A $512 \times 512$ sensor with 16 $\mu$m pixel pitch is placed at $z_w=125$ mm.
100,000 photons are emitted isotropically from $(0.25, 1, 2)$ mm (world 
coordinates).
We emit an unrealistically high number of photons so that image truncations are 
clearly observable.
Acceptance zones for each mirror reflection are derived and overlaid on the image.
The resulting image is shown in \cref{fig:trunc_examples}.

\begin{figure*}
\centering
\includegraphics[width=\linewidth]{trunc_horiz.png}
\caption{\textbf{Simulated kaleidoscopic image with theoretical acceptance zones.} 
Acceptance zones are derived for each mirror reflection and overlaid in gray on 
the image for the (a) +$x$, (b) +$y$, (c) -$x$, and (d) -$y$ mirror reflections.} 
\label{fig:trunc_examples}
\end{figure*}